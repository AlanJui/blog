---
layout: post
title: 如何讓Node Express開發的Web Application可於開機後自動啟動
date: '2013-10-31T23:38:00.003+08:00'
author: 居正中
tags:
- AWS EC2
- Web技術
- Node.js
modified_time: '2013-11-01T11:23:48.782+08:00'
blogger_id: tag:blogger.com,1999:blog-1068034375721560223.post-673846810436246516
blogger_orig_url: http://blog.ccc99.tw/2013/10/node-expressweb-application.html
---

使用 Node.JS 及 Express 開發的 Web Application，因為底層沒有如 Apache 的 Web Server，所以，基本上，無法滿足「作業系統完成開機後，便自動啟動」的需求。<br /><br />這下麻煩可大了，我們這個自動啟動的需求，該如何滿足？<br /><br />還好，在 Linux 的世界，有個名為：「supervisor」的工具軟體。這套軟體的用途為：提供使用者，可對 UNIX-like 作業系統上執行的程式（processes），進行監視及控管。<br /><br />透過這套工具，能讓我們將開發好的 Web Application，當成作業系統的服務（System Service）來用；而「作業系統的服務」因為可設成開機後自動啟動，所以，以上所述的需求，自然就能滿足了。<br /><br />以下的安裝、設定程序，系以下列所示之環境為前題，因此，讀者在使用的時候，可能無法照著全抄，得需配合個人的環境，進行調整。<br /><ul><li>Node執行檔安裝之目錄路徑： <span style="color: red;">/usr/bin/local/node</span>&nbsp;</li><li>Express Web Application的安裝路徑： <span style="color: red;">/web/todos/app.js&nbsp;</span></li><li>Express Web Log檔存放路徑：<span style="color: red;">/web/logs</span>&nbsp;</li></ul><br /><h4>執行程序</h4>（1）安裝supervisor套件。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ sudo easy_install supervisor</div><br />（2）透過指令產生「設定檔」。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ sudo echo_supervisord_conf &gt; /etc/supervisord.conf</div><br />（3）編輯設定檔，加入Node.JS Web App。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ sudo vim /etc/supervisord.conf</div>在檔案的最底端，添加如下內容：<br /><div style="background-color: #cccccc; line-height: 1.6em; margin: 12px 0px; padding: 6px;"><span style="color: black;">[program:</span><span style="color: red;">myWebApp</span>]<br />command=<span style="color: red;">/usr/local/bin/node app.js</span><br /><span style="color: black;">directory=</span><span style="color: red;">/web/todos</span><br /><div style="color: black;">autostart=true</div><div style="color: black;">autorestart=unexpected</div><div style="color: black;">startsecs=2</div><div style="color: black;">startretries=3</div><div style="color: black;">exitcodes=0,2</div><span style="color: black;">stdout_logfile=</span><span style="color: red;">/web/logs/myWebApp.log</span></div><ul><li>program之後的名稱：myWebApp非強制性的規範，可由個人自行決定。</li><li>Express Web的主程式app.js檔，其存放目錄路徑為「/web/todos」，但在「command」欄位，沒有標示出app.js檔案所在目錄路徑；反而標明在「directory」欄位中，這點須請留心。</li><li>以上設定檔的「directory」、「stdout_logfile」、「command」欄位，很可能跟讀者的環境不同，請依個人需求自行修改。</li></ul><br />（4）在路徑為：「/etc/rc.d/init.d」的目錄下，建立名為「supervisord.sh」的bash指令稿檔案。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ sudo vim /etc/rc.d/init.d/supervisord.sh</div>完成編輯後，bash指令稿檔案的內容：<br /><div style="background-color: #cccccc; color: black; margin: 12px 0; padding: 6px;">#!/bin/sh<br />#<br /># /etc/rc.d/init.d/supervisord<br />#<br /># Supervisor is a client/server system that<br /># allows its users to monitor and control a<br /># number of processes on UNIX-like operating<br /># systems.<br />#<br /># chkconfig: - 64 36<br /># description: Supervisor Server<br /># processname: supervisord<br /><br /># Source init functions<br />. /etc/rc.d/init.d/functions<br /><br />prog="supervisord"<br /><br />prefix="/usr/"<br />exec_prefix="${prefix}"<br />prog_bin="${exec_prefix}/bin/supervisord"<br />PIDFILE="/var/run/$prog.pid"<br /><br />start()<br />{<br />&nbsp; echo -n $"Starting $prog: "<br />&nbsp; daemon $prog_bin --pidfile $PIDFILE<br />&nbsp; [ -f $PIDFILE ] &amp;&amp; success $"$prog startup" || failure $"$prog startup"<br />&nbsp; echo<br />}<br /><br />stop()<br />{<br />&nbsp; echo -n $"Shutting down $prog: "<br />&nbsp; [ -f $PIDFILE ] &amp;&amp; killproc $prog || success $"$prog shutdown"<br />&nbsp; echo<br />}<br /><br />case "$1" in<br /><br />&nbsp; start)<br />&nbsp; &nbsp; start<br />&nbsp; &nbsp; ;;<br /><br />&nbsp; stop)<br />&nbsp; &nbsp; stop<br />&nbsp; &nbsp; ;;<br /><br />&nbsp; status)<br />&nbsp; &nbsp; status $prog<br />&nbsp; &nbsp; ;;<br /><br />&nbsp; restart)<br />&nbsp; &nbsp; stop<br />&nbsp; &nbsp; start<br />&nbsp; &nbsp; ;;<br /><br />&nbsp; *)<br />&nbsp; &nbsp; echo "Usage: $0 {start|stop|restart|status}"<br />&nbsp; &nbsp; ;;<br /><br />esac</div><br />（5）設定supervisord.sh，使能開機後，自動執行。<br /><br />5-1) 變更 supervisord.sh 檔案權限，使其可「執行」。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ sudo chmod +x /etc/rc.d/init.d/supervisord.sh</div>5-2) 確認 supervisord.sh 檔案己具備可執行之權限。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ ls -al /etc/rc.d/init.d/supervisord.sh<br />-rwxr-xr-x 1 root root 993 2013-10-31 07:38 /etc/rc.d/init.d/supervisord.sh</div>5-3) 查詢 supervisord.sh 檔案，在「作業系統服務 (System Service)」的「操作環境級別（Run Level）」。不過，以下的指令，最主要的目的，是要透過無法正常執行的結果，來證實 supervisord.sh 尚未完成註冊動作，所以無法查詢其「操作環境級別」，只會獲得錯誤訊息。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ chkconfig --list supervisord.sh<br />supervisord.sh 服務支援 chkconfig，但未向任何執行等級註冊（請執行 'chkconfig --add supervisord.sh'）</div>5-4) 將 supervisord.sh 註冊成作業系統的「服務」。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ sudo chkconfig --add supervisord.sh</div>5-5) 設定 supervisord.sh 服務的操作環境級別，使之可以在作業系統完成開機後，便能自動啟動。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ sudo chkconfig supervisord.sh on</div>5-6) 查詢 supervisord.sh 檔案，在作業系統「服務」中的「操作環境級別」（2,3,4,5）。<br /><div style="background-color: black; color: lime; margin: 12px 0; padding: 6px;">$ chkconfig --list supervisord.sh<br />supervisord.sh 0:關閉 1:關閉 2:開啟 3:開啟 4:開啟 5:開啟 6:關閉</div><div>完成以上設定工作後，請重開機。於確定重開機完成後，請找台 Web Client 端的電腦，打開 Web 瀏覽器，輸入網址，確認是否能連上你的 Web Application ，以便驗證此文所述之需求己經達成。<br /><br />關於 Supervisor 的網路參考文章：<br /><ul><li><a href="http://thegoodbits.sulpy.com/blog/2013/07/13/how-to-build-a-resilient-aws-ec2-linux-instance-utilizing-nginx-and-node-dot-js/" target="_blank"></a><a href="http://thegoodbits.sulpy.com/blog/2013/07/13/how-to-build-a-resilient-aws-ec2-linux-instance-utilizing-nginx-and-node-dot-js/" target="_blank">How to build a resilient AWS EC2 Linux instance utilizing nginx and node.js</a></li><li><a href="http://serverfault.com/questions/96499/how-to-automatically-start-supervisord-on-linux-ubuntu" target="_blank">How to automatically start supervisord on Linux (Ubuntu)</a></li><li><a href="http://www.andretw.com/2013/02/supervisor.html" target="_blank">管理與啟動你的程式: Supervisor</a></li></ul></div><div></div>